# 第二章 直连网络

> 直连网络的架构处于IP层之下

[toc]

## 构建直连网络需要解决的问题

- 信道编码
- 组帧
  - 比特序列→帧
- 错误检测
- 可靠传输
- 介质访问控制
  - 协调多主机对链路的访问

## 数据通信的基本概念

> 数据是运送消息的载体
> 模拟信号是连续的，数字信号是离散的
> 码元表示不同离散数值的基本波形

### 信道相关概念

- 单工通信
  - 发送器向接收器传输数据，无反向交互
  - 如无线电广播
- 半双工通信
  - 具有双向传输功能，但每个时刻只显示一种特征
  - 如总线型以太网
- 全双工通信
  - 通信双方可同时收发消息
  - 如交换型以太网

### 基带信号

> 基带信号指来自信源的原始信号，分为数字基带信号和模拟基带信号。特点是**频率较低，信号频谱从零频附近开始，具有低通形式** 。

- 近距离内基带信号衰减不大，如打印机外设、以太网等局域网。
- 长距离或无线信道传输基带信号需要调制。

#### 调制

> 调制指将基带信号变换方式后传输

##### 调制的目的

- 将信号变换为便于传输的形式
- 有效利用频带

##### ※调制的种类

- 编码调制：也称基带调制。变换波形，编码后为适应信道特征的另一种基带信号。
- 带通调制：也称载波调制。使用载波把基带（模拟）信号搬到高频，转换为模拟信号。

### 编码调制

二进制数据转变为可在链路上传输的电磁波信号，分为两层：

- 上层，编码调制
  - 发送端：比特→数字基带信号
  - 接收端：数字基带信号→比特
- 下层，带通调制
  - 基带信号→相应介质中易于传输的信号形式

#### 数字基带信号

##### 二元码

矩形波形。取值为0和1两种电平。

- 常见形式
  - 单极性不归零码
  - 双极性不归零码
  - 单极性归零码（每个时钟周期后半归零）
- 问题
  - 存在无跳变的固定连续电平，无法提取时钟信号
- 应用
  - 机内外近距离信息传递
  - 不能上信道

###### 曼彻斯特码

- 一个周期的方波表示1，反向波形表示0
- 一旦极性反转，所有比特全部反转

###### ※差分曼彻斯特码

- 引入差分码概念，用电平相对值而非绝对值表示
- 相邻周期的方波反相表示1，同相表示0
- 避免极性反转引发解码错误
- 优点
  - 码元周期中存在电平跳变，易于不受信源影响地提取时钟
  - 周期内正负电平各半，无直流分量
- 缺点
  - 比特率为波特率（信号变化速度）一半，编码效率仅50%
- 应用
  - 以太网

##### 准（伪）三元码

单极性变双极性，取值为+和0和-三种电平。
**不是三进制**

##### 多元码

- 每个符号表示一个二进制组码
- 二元码改为$2^n$元码，信道利用率提高$n$倍；同样速率下传送的信息量也提高$n$倍。
- 问题：增加了系统实现的复杂度（电平更多）

##### 码型设计原则

1. 变换过程对信源透明，与信源统计特性无关
2. 从传输码型容易提取时钟（时钟必须精确同步）
3. 具有自检能力
   - 要求码元间有相关性（冗余度），即相互不独立
   - 推论：各码元所含信息量不为最大
4. 误码增值尽量小
   - 传输中产生n位错误，解码后最多也只有n位错误
5. 编译码器简单方便
6. 编码唯一可解

### 带通调制

> 基本调制方法
>
> - 调幅（AM）
> - 调频（FM）
> - 调相（PM）

#### 数字信号调制

##### 二进制数字调制

- 幅度键控
  - 通断键控。如，1通，0断。
- 频移键控
  - 如1频率高，0频率低。
- 相移键控
  - 相位分别取0°和180°。

##### 模拟信号调制

- 调幅
  - 载波振幅随调制信号大小做线性变化（物理上的拍）

### 信道容量与计算

> 实际信道传输存在各种失真、多种干扰（带宽受限、噪声）。
> 引起失真的因素包括：
>
> - 码元传输速率高
> - 信号传输距离远

#### ※香农公式

$C = W \cdot \log_2(1 + S/N)$

其中，C为信道容量（bps），W为信道带宽（Hz）
S为信号平均功率，N为高斯白噪声功率
S/N为信噪比，用SNR（dB）表示，SNR=$10\log_{10}(S/N)$

> - 计算结果是信道信息传输速率（信道容量）的理论上限
> - 只要传输速率小于这一极限，就可以找到实现无差错传输的办法
> - 增加信道带宽W时，高斯白噪声功率$N=Wn_0$也增大
> - $\lim_{W\rightarrow \infty}W\log_2(1+\frac{S}{n_0W})=1.44\frac{S}{n_0}$
> - 实际信道的信息传输速率远低于极限传输速率。存在脉冲干扰等信号损伤
> - 包括多元码等方式在内，都只是提高实际传输速率，不影响香农公式推导的理论上界

## 网络构件

### 网络结点

- 被连接的计算机等硬件，分为主机和网络内部交换结点
- 通过网络适配器/网络接口卡实习到链路的连接

#### 网络适配器

实现大部分数据链层和全部物理层功能
包括组帧、编码、调制、解调、解码、识别帧
对等结点的虚通道上：错误检测、可靠传输、介质访问

### 网络链路

> 物理层之下，数据传输的物理通道（光速）

- 按介质分类
  - 导引型，即有线链路
  - 非导引型，即无线链路
- 按通路分类
  - 点对点链路
    - 单个发送方和单个接收方
    - PPP协议和HDLC等协议
  - 广播链路（多路访问）
    - 多个结点连接到同一广播信道
    - 所有结点都能收到任意节点发的帧
    - 需要解决介质接入控制问题
    - 以太网、局域网
- 属性
  - 频率
  - 波长

#### 导引型传输媒体

- 双绞线
  - 几到几十公里，可通过中继器、放大器增加距离
  - 导线越粗传输距离越长
- 同轴电缆
  - 屏蔽性好，用于基带传输
  - 如有线电视
- 光纤
  - 通过光脉冲全反射
  - 有无脉冲分别为1和0
  - 损耗小，中继距离长，适合远距离传输
  - 抗电磁干扰
  - 保密性好
  - 分为多模和单模
    - 多模光纤含多种入射角光线，光脉冲会展宽、失真
    - 单模光纤直径为一个光的波长，直线传播无反射

#### 非导引型传输媒体

- 通过天线发送和传输
- 分为定向/全向两种类型。前者需要校准
- ISM频段（工/科/医频段）

## 组帧

> 大部分功能由网络适配器完成

网络适配器的**信令组件**把比特编码为信号/信号解码为比特
对分组交换网络，结点交换数据帧而非比特流
**关键：** 准确识别哪些比特构成一帧

包括两方面协议：面向字节/比特的协议

### 面向字节的组帧

> 最早的组帧方法，一帧是一个字节集

#### ※起始标记法（BISYNC/PPP）

> 特定字符表示帧的开始与结束

实例：BISYNC

**要求：** 数据帧的透明传输。任意比特组合都能通过数据链路层
**解决：** 字符填充法。转义符转义转义符和结束符

#### ※字节计数法（DDCMP）

> 帧的字节数放在首部字段

实例：DDCMP
长度字段指示结束

**缺点：** count出错时会有累计错误

### ※面向比特的组帧

- 不关心字节边界。把帧看成比特集
- 比特数随意

实例：高级数据链路控制协议（HDLC）

- 明确的开始序列和结束序列（标志字段）
- 链路空闲时也发送这一序列，保证时钟同步
- 透明传输的实现：比特填充法
  - 发送方：加入标志字段前，扫描整个帧。每5个连续1后填充1个0
  - 接收方：接收连续5个1后检查下一位。若是0（填充位），丢弃。若是1，继续检查下一位。若为0则帧结束，若为1则出错。

## 差错检测

- 数据传输可能会产生**比特差错**，即比特位反转
- 传输错误的比特占比特总数的比率称为**误码率**
- 差错检测的基本思想：在数据帧加入**冗余信息**
- 接收方可以采用**重传机制**或**纠错码**（成本高）
- 目标：使用最少的冗余比特检测最多的错误
- 纠错码的冗余位更长，编码效率低
  - 一般用在高差错率（无线环境）、重传代价高（卫星链路）、无法重传（单工信道）等情况

### 奇偶校验

- 单向奇偶校验
  - 单个奇偶校验位
  - 奇/偶校验：d比特信息和1比特校验位中1的总数为奇/偶数
  - 只可检测出奇数个比特差错
- 二位奇偶校验
  - d比特信息分为i行j列，对每行每列计算奇偶值，得到i+j+1个校验位
  - 对1比特错可以检测并纠错；对2比特错只能检测
  - 要求行列校验方式相同

### 校验和（IP层及传输层等上层）

> 基本思想：
>
> - 计算所有字的和，一起传输
> - 接收端同样计算并比较，不同则判断出错

#### TCP/IP协议使用的校验和（RFC 1071）

- 发送方把数据分为16位字的序列，用将所有字反码相加后取反码，即为校验和
  - 反码求和：最高位进位时回卷到最低位
- 接收方将所有16比特字（包括校验和）相加，结果为全1则无差错
- 冗余少（16比特），检测能力较弱
- 易于软件实现，用于上层端到端协议。下层由链路层保障

### ※循环冗余校验（链路层）

- n次多项式可以表示n+1比特消息，比特消息一一映射到多项式
- 收发双方商定一个k次幂的除数C(x)
- 对n比特消息M(x)，发送加上k比特冗余的消息P(x)，使P(x)能被C(x)整除
- 计算P(x)
  1. 产生零扩展消息T(x)。$T=M \ll k$
  2. C(x)除T(x)得余数S(x)。$S=T\%C$（异或减）
  3. T和S相减得到P。$P=T \oplus S$
- 验证：校验$P\%C==0$

**如何选择C(x)：**

- 当且仅当差错多项式$E(x)=P^\prime(x)-P(x)$能被C(x)整除时，错误查不出
- 第k和0项系数非零，可检测所有但比特错
- 含有一个至少3项的因子，可检测所有双比特错
- 含有因子x+1，可检测任意奇数个错
- 任何组长度小于k比特的连续差错，能检测

## 可靠传输

- 差错检测计数只能做到（理论上）无差错接受
- 可靠传输的目标是恢复丢失或被丢弃的帧
- 链路层、传输层、应用层都可以提供可靠传输（不同层方式可能不同）
- 自动请求重发机制(ARQ)
  - 停等（停止等待）算法和滑动窗口算法

### 可靠传输的基本机制

- 确认机制
  - 给对等实体发送消息，告知已收到
  - 无数据头部作为控制帧或捎带在数据帧中
- 超时机制
  - 在合理的一段时间（超时/timeout）内发送方若未收到确认，则重发原始帧

### 停止等待算法

> 传输下一帧前等待ACK。若一段时间内未达到则重发。

- 过早超时：下一个超时内收到两个ACK
- 过早超时和ACK丢失都会引起**重复帧问题**

#### 包含1比特序列号的停等算法

- 交替使用0和1作为帧号
- 只允许链路上有一个未确认帧，可能导致链路使用率低
  - 与时延带宽积比较，希望保持**管道满载**

### ※滑动窗口算法

- 通过使用多个比特所谓帧号，增加单位时间传输数据帧的数目
- 允许多个在途传输（未收到ACK）的数据帧
- 通过窗口大小限制在途传输的数据帧个数，给每个数据帧赋予一个序列号
  - 序列号在大小有限的首部字段中，可重用、回绕
  - 可用序列号必须**大于**待确认帧数（必须不占满一个周期，否则会无法区分重传/新一位）
  - 进一步，要求发送窗口大小**不超过**可用序列号的一半（否则窗口滑动后会产生期望与重传的重合）
- 总结
  - 可靠传输：基于确认和超时重传，在不可靠链路上可靠传输
  - 高效传输：并发传输提高性能
  - 按序传送：缓存不连续数据，向上层提交连续数据
  - 流量控制：接收方能控制发送方使之降低速度；双方都可通过窗口大小设定收发能力

#### 滑动窗口算法的发送方

- 维护三个状态变量
  - 发送窗口大小（SWS）
  - 最近被确认过的帧序号（LAR）
  - 最近发送的帧的序号（LFS）
- 收到ACK时右移LAR；**窗口允许时**发送新的帧并更新LFS
- 每帧设置定时器，若收到ACK前超时，重传该帧
- 必须能缓存SWS个帧
- 根据延迟带宽积选择SWS大小（一段时间内链路上最多可有多少待确认帧）

#### 滑动窗口算法的接收方

- 维护三个状态变量
  - 接收窗口大小（RWS）
  - 最大可接受帧序号（LAF）
  - 最后确认接受的帧序号（LFR）
- 将收到的**最大连续**数据帧的序号作为ACK回复
- RWS=1时，不缓存任何错序到达的帧；RWS=SWS时，缓存所有帧；RWS>SWS无意义

#### 数据帧丢失的处理

- 回退N机制
  - 接收方只对连续收到的数据帧回复ACK
  - 超时后发送方重传LAR+1与LFS之间的数据帧
- 选择确认机制
  - 接受方准确确认每个已接收的数据帧，发送方更快重传
  - 避免冗余传输，传输效率高，实现复杂

## 媒体共享

- 静态划分信道（信道复用）
  - 划分逻辑信道
  - 频分复用、时分复用、波分复用、码分复用
  - 使用控制器、仲裁器
  - 分配固定带宽
  - 强调公平性
  - 用于传统音像系统和移动蜂窝网络的物理层
- 动态媒体接入控制（多点接入）
  - 分布式算法在实际接入时不固定分配
  - 随机接入：按需随机，存在碰撞问题
  - 受控接入：服从控制，如令牌环网
  - 不适用控制器、仲裁器
  - 强调自组织和带宽利用率
  - 用于MAC层互联网数据传输（以太网、WIFI）

### 信道复用方法

#### 频分复用

- 所有用户在同样的时间占用各自被分配的带宽资源
- 如早期有线电视网络、光纤通信网络（不常见）、模拟电话系统

#### 时分复用

- 将时间划分为等长的时分复用帧（TDM帧）
- 每个用户在每个TDM帧种占用固定序号的帧，不同时间占据同带宽的帧
- 由于数据传输突发性，总带宽利用率不高

##### 统计时分复用（STDM）

- 按需动态分配时隙
- 每个STDM帧中时隙数小于用户数
- 用户占用时隙非周期出现（异步时分复用）
- 时隙必须加入用户信息
- **IP数据包对于网络链路的复用方式符合统计时分复用的特征**

#### 波分复用

- 光载波频率高，按波长区分波段（和频分本质相同）

#### 码分复用（CDM）

- 码分多址（CDMA）
  - 基于扩频技术
    - 发送端用大带宽（高速伪随机码）对原信号调制，扩展带宽后再经过载波调制发送
    - 接收端用同一伪随机码解扩（解调为窄带信号）
  - 抗干扰能力强
- 码片
  - 把1比特时间划分为m个短间隔
  - 每个用户被指派唯一的m比特码片序列
    - m为64或128
    - 扩频：信息实际发送时，数据率和频带宽度提高到m倍
    - 发送比特1时，发送原码片序列
    - 发送比特0时，发送码片序列反码（一般用-1表示）
- 信道复用的实现
  - 每个站分配的码片序列各不相同且相互正交
  - 对码片S和T，满足$S \cdot T = \frac{1}{m}\sum\limits_{i=1}^m{S_iT_i} = 0$
  - 推论：$S \cdot S = 1$，且$S \cdot !S = -1$
  - 接收端用自己的码片和收到的总信号求内积
    - 结果为1，发送信号为1
    - 结果为-1，发送信号为0
    - 结果为0，未发送信号

> 码片序列相当于基向量

### 多点接入方法

#### 随机接入

- 结点按需随机接入，接入后全速发送
- 碰撞时相关结点反复重发，直到无碰撞成功发送
  - 冲突域
  - 碰撞
- 各节点重发前独立选择随机时延

##### ALOHA

- 能用于任何传输介质
- 帧从网络层首次到达链路层时立即发送
- 碰撞时，以概率p立刻重传，1-p概率等待一个帧传输时间（称为p-坚持）
- 若还不成功，继续上述过程
- 考虑N个结点，信道利用率为$Np(1-p)^{2(N-1)}$，当$N \rightarrow \infty$时极限值为$\frac{1}{2e} \approx 18 \%$

##### 时隙ALOHA

- 设帧长为L bit，传输速率为R bit/s，把时间划分为L/R s的时隙（即传输一帧的时间）
- 结点在时隙开始时发送
- 重传机制与ALOHA相同
- 信道利用率在极限情况下约为37%（两倍）

##### 载波侦听多点接入（CSMA）

- 多点接入
  - 广播链路，多个节点连在同一链路、同一冲突域
- 载波侦听
  - 发送前检测信道，识别链路的忙闲状态，避免碰撞
  - 若结点具备同时收发数据的能力，则在发送时也要监听信道。发生碰撞时立即停止发送，并按策略重发
- 根据具体的侦听/发送策略分类
  - 非持续CSMA：q概率侦听，1概率发送。等待随机时间，减少碰撞但增长延迟，降低信道利用率
  - 1-坚持CSMA：1概率侦听，1概率发送。增加碰撞，降低性能
  - p-坚持CSMA：1概率侦听，p概率发送。通过调节p平衡碰撞和信道利用率
- 碰撞的产生是由于存在信号传播时延

> 注意区分发送决策和发送动作。做出发送决策不意味着进行发送动作

##### 带碰撞检测的CSMA

- 1-坚持CSMA + 碰撞检测
- 碰撞检测
  - 发送数据同时检测信号电压摆动值
  - 判断碰撞后立刻停止发送，并等待随机时间
- 侦听/发送
  - 信道忙时持续侦听
  - 信道空闲时等待一个最小帧间间隔时间后传输
- 碰撞处理
  - 碰撞时停止发送，并发送人为干扰信号作为特殊阻塞信息
  - 退避一段时间后重传
    - 根据碰撞次数计算的指数退避时间
  - 尝试若干次后放弃并报错
- 应用于总线型以太网（半双工链路）
  - 结点不能同时收发数据
  - 结点可以边发送边侦听
- 碰撞窗口/争用期
  - 发送数据后存在碰撞可能的一小段时间，时长取决于碰撞两点的距离
  - 端到端**往返**时延即为争用期。争用期内若没有碰撞，则确定发送无碰撞
    - 因为单程时间后接收端必定不会再发出信号，所以需要再等待单程时间
  - 推论：CSMA/CD的帧必须足够长
- 强化碰撞
  - 检测到碰撞后立刻停发；同时发送高强度干扰信号
- 指数退避算法
  - 碰撞后退避的随机时间
  - 基本退避时间为争用期
  - 随机选取小于$2^k$的整数作为倍数，乘基本退避时间得到退避时延
  - k为重传次数，不超过10，避免过大
  - 重传16次仍失败时丢弃该帧并报告

##### 带碰撞避免的CSMA

- 非持续CSMA + 碰撞避免
- 应用于无线局域网
  - 无线网络适配器接收信号强度远小于发送信号，而碰撞检测要求节点同时检测收发，故代价过大
  - **隐藏终端**等问题使得碰撞难以检测
- 即使碰撞也继续传输数据帧
- 隐藏终端
  - 互相检测不到信号的终端对同一目标发送信号，引发碰撞
  - 有线传输中不存在（**- Why？- Maybe 无法检测电压震荡**）
- 侦听/发送
  - 信道忙时等待、再侦听
  - 信道空闲时等待（分布式帧间间隔DIFS）立即发送
  - 若不是第一次发送，执行碰撞避免操作后发送
- 碰撞避免
  1. 信道空闲一段时间（DIFS）后进入竞争窗口，根据退避时间延迟接入
    - 算法类似与CSMA/CD，但所有结点都要退避
    - 退避期间若信道忙，则冻结计时，直到空闲持续DIFS时间后继续
  2. 发送、接收节点通过RTS/CTS短帧预约信道避免碰撞（**预约机制**）
  3. 通过虚拟载波监听机制预留信道（**通告机制**）
    - 预留时长等于发送节点在RTS/CTS中的NAV和数据帧MAC头的占用信道时间

#### 受控接入

- 用户服从一定控制
- 如令牌环网，每个站点发送前需要获得令牌（许可）

## 以太网

- 局域网：数据链路层。传输速率高
- 802.11规范：无线局域网
- 802.3规范：CSMA/CD MAC物理层
- 中继器作用在比特；交换机作用在帧
- 中继器连接各段结点，增加覆盖范围
- 总线型和星型以太网
- “硬件地址/MAC地址”是适配器的唯一以太网地址，但只是标识符，不是真正意义的“地址”
- 以太网适配器接收（receive）所有帧，但只接受（accept）并向主机传送部分帧
- 以太网不提供可靠传输，重传校验等由上层负责
- 曼彻斯特编码，面向比特组帧，CRC差错检测，CSMA/CD方式媒体共享
- 以太网扩展方式：物理层（由于CSMA/CD，节点越多碰撞越复杂）/数据链路层
- **接线器连接的范围内属于同一碰撞域**
- 总线型以太网的数据包越小，单位数据传输成本越大；网络负载越大，传输性能越低
